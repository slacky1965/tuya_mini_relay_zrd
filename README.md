# <a id="Top">Tuya Switch with power monitoring with custom firmware</a>

### Custom firmware for Tuya Switch models

- _TZ3000_kqvb5akv

[Repository tuya_mini_relay_zrd](https://github.com/slacky1965/tuya_mini_relay_zrd)

---

<img src="doc/images/mini_relay.jpg"/>

**Автор не несет никакой отвественности, если вы, воспользовавшись этим проектом, превратите свой умный switch в полоумный.**

Если у вас другая сигнатура, лучше не заливать, не проверив на совпадение используемого модуля и GPIO.

## Зачем. 

Невозможно было настроить репортинг под свои нужды. Настройки были, но ни на что не влияли.

## Что получилось. 

**About**

<img src="doc/images/about.jpg"/>

---

## <a id="settings">Настройка</a>

**Вкладка `Exposes`**

<img src="doc/images/exposes.jpg"/>

- `State` - выводит текущее состояние реле.
- `Power-on behavior` - настраивает в какой режим переходит реле при подаче питания.
- `Switch actions` - настраивате, какую команду выполнять при нажатии на выносную клавишу.
- `Switch type` - настраивает тип клавиши: `toggle` - звонковая, `momentary` - обычная перекидная, `multifunction` - множественные нажатия, от 1 до 5, удержание и отпускание. Выбор `multifunction` автоматически приводит к отвязыванию клавиши от реле.
- `Operation mode` - настраивает управление реле с клавиши или отключает управление (отвязывание клавиши).
- `Power` - выводит текущее значение мощности.
- `Voltage` - выводит текущее значение напряжения.
- `AC frequency` - выводит текущее значение частоты.
- `Current` - выводит текущее значение силы тока.
- `Energy` - выводит текущее значение накопленной энергии.
- `Energy reset` - сбросить на 0 текущее значение накопленной энергии.
- `Action` - выводит дейстивие клавиши в режиме `multifunction`.
	- `hold` - удержание,
	- `single` - одиночное нажатие,
	- `double` - двойное нажатие,
	- `triple` - тройное нажатие,
	- `quadruple` - четверное нажатие,
	- `quintuple` - пятерное нажатие,
	- `release` - отпустили клавишу, приходит после `hold`.

---

**Вкладка `Reporting`**

<img src="doc/images/reporting.jpg"/>

Настройка репортинга.

Репортинг кластера `OnOff` и кастомного атрибута лучше не трогать.

Репортинг остальных параметров можно настроить в соответствии с вашими желаниями. 

---

Реле поддерживает прямой биндинг. Причем не важно, отязана клавиша или нет.

---

Немного про запись накопленной энергии. Были жалобы, что такие реле часто просто так мрут. Считывание параметров сети происходит раз в секунду. Есть подозрение, что накопренную энергию они сохраняют в одно и тоже место. В этой прошивке применен другой метод. С адреса 0x96000 по адрес 0xFC000 находится неиспользуемое пространство (Reserved Area. см. [drv_nv.h](tl_zigbee_sdk/proj/drivers/drv_nv.h) для прошивок без бутлоадера). Размер этой области составляет 0x66000 (417792 байт). Запись происходит каждый раз в новое место с шагом 256 байт. Итого мы имеет 1632 сегмента для записи. Запись происходит по кругу. Запись осуществляется по изменению параметра накопленной энергии, но не чаще 1 раза в минуту. Для визуального контроля за частотой записи, каждый раз при записи зажигается светодиод.

---

Подключение к сети происходит при длительном удержании кнопки на самом реле. Или при переключении клавиши не менее 10 раз подряд.

---

Как обновить можно почитать [вот тут](https://github.com/slacky1965/ts0201_tz3000_zed/blob/main/README_rus.md#%D0%BA%D0%B0%D0%BA-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C), действовать по аналогии. Единственное отличие, второй раз обновлять не нужно, убрана промежуточная версия.

---

Отдельная благодарность Виктору за разъяснение, как сделать более универсальную прошивку - [pvvx](https://github.com/pvvx/ZigbeeTLc)

---

Связаться со мной можно в **[Telegram](https://t.me/slacky1965)**.

### Если захотите отблагодарить автора, то это можно сделать через [ЮMoney](https://yoomoney.ru/to/4100118300223495)

---

## История версий
- 1.0.01
	- Начало.
- 1.0.02
	- Добавлены `Actions` для клавиши.
- 1.0.03
	- Изменена обработка записи накопленной энергии.
	

[Наверх](#Top)


